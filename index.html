<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calm Bill Splitter</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fb923c"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2Y5NzMxNiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjQiIHk9IjIiIHdpZHRoPSIxNiIgaGVpZHRoPSIyMCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PGxpbmUgeDE9IjgiIHkxPSI2IiB4Mj0iMTYiIHkyPSI2Ij48L2xpbmU+PGxpbmUgeDE9IjEyIiB5MT0iMTAiIHgyPSIxMiIgeTI9IjE4Ij48L2xpbmU+PGxpbmUgeDE9IjgiIHkxPSIxNCIgeDI9IjE2IiB5Mj0iMTQiPjwvbGluZT48L3N2Zz4=">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Calm Bill Splitter","short_name":"BillSplit","start_url":".","display":"standalone","background_color":"#fdf2f8","theme_color":"#fb923c","description":"A calm way to calculate your electricity bill share.","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2Y5NzMxNiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjQiIHk9IjIiIHdpZHRoPSIxNiIgaGVpZ2h0PSIyMCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PGxpbmUgeDE9IjgiIHkxPSI2IiB4Mj0iMTYiIHkyPSI2Ij48L2xpbmU+PGxpbmUgeDE9IjEyIiB5MT0iMTAiIHgyPSIxMiIgeTI9IjE4Ij48L2xpbmU+PGxpbmUgeDE9IjgiIHkxPSIxNCIgeDI9IjE2IiB5Mj0iMTQiPjwvbGluZT48L3N2Zz4=","sizes":"192x192","type":"image/svg+xml"},{"src":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2Y5NzMxNiIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxyZWN0IHg9IjQiIHk9IjIiIHdpZHRoPSIxNiIgaGVpZ2h0PSIyMCIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PGxpbmUgeDE9IjgiIHkxPSI2IiB4Mj0iMTYiIHkyPSI2Ij48L2xpbmU+PGxpbmUgeDE9IjEyIiB5MT0iMTAiIHgyPSIxMiIgeTI9IjE4Ij48L2xpbmU+PGxpbmUgeDE9IjgiIHkxPSIxNCIgeDI9IjE2IiB5Mj0iMTQiPjwvbGluZT48L3N2Zz4=","sizes":"512x512","type":"image/svg+xml"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        .form-input {
            transition: all 0.3s ease-in-out;
        }
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.3);
            border-color: #fb923c;
        }
         .btn-primary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        .separator {
            display: flex;
            align-items: center;
            text-align: center;
            color: #9ca3af;
            margin: 2rem 0;
            font-weight: 500;
        }
        .separator::before,
        .separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .separator:not(:empty)::before {
            margin-right: .75em;
        }
        .separator:not(:empty)::after {
            margin-left: .75em;
        }
        .alert-toast {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-rose-50 to-teal-50 flex items-center justify-center min-h-screen px-4 py-8">

    <div class="bg-white/80 backdrop-blur-sm p-8 rounded-2xl shadow-lg w-full max-w-md border border-white">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-700">Electricity Bill Splitter</h1>
            <p class="text-slate-500 mt-2">A calm way to calculate your share.</p>
        </div>
        
        <form id="billForm">
            <!-- Main Meter Section -->
            <div class="separator">Main Meter Details</div>
            <div class="space-y-4">
                 <div>
                    <label for="totalAmount" class="block text-sm font-medium text-slate-600 mb-1">Total Bill Amount (₹)</label>
                    <input type="number" step="0.01" id="totalAmount" placeholder="e.g., 3270" class="form-input bg-slate-50 w-full p-3 border border-gray-300 rounded-lg text-lg" required>
                </div>
                <div>
                    <label for="totalUnits" class="block text-sm font-medium text-slate-600 mb-1">Total Main Meter Units</label>
                    <input type="number" id="totalUnits" placeholder="e.g., 537" class="form-input bg-slate-50 w-full p-3 border border-gray-300 rounded-lg text-lg" required>
                </div>
            </div>
            
            <!-- Sub Meter Section -->
            <div class="separator">Nishat's Sub Meter</div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="nishatPresentReading" class="block text-sm font-medium text-slate-600 mb-1">Present Reading</label>
                    <input type="number" id="nishatPresentReading" placeholder="e.g., 16362" class="form-input bg-slate-50 w-full p-3 border border-gray-300 rounded-lg text-lg" required>
                </div>
                 <div>
                    <label for="nishatLastReading" class="block text-sm font-medium text-slate-600 mb-1">Last Month's Reading</label>
                    <input type="number" id="nishatLastReading" placeholder="e.g., 15976" class="form-input bg-slate-50 w-full p-3 border border-gray-300 rounded-lg text-lg" required>
                </div>
            </div>
            
             <!-- Price Section -->
            <div class="separator">Individual Pricing</div>
             <div class="grid grid-cols-2 gap-4 mb-8">
                <div>
                    <label for="nishatPrice" class="block text-sm font-medium text-slate-600 mb-1">Nishat's ₹ / Unit</label>
                    <input type="number" id="nishatPrice" step="0.01" placeholder="e.g., 6.50" class="form-input bg-slate-50 w-full p-3 border border-gray-300 rounded-lg text-lg" required>
                </div>
                 <div>
                    <label for="dilshanPrice" class="block text-sm font-medium text-slate-600 mb-1">Dilshan's ₹ / Unit</label>
                    <input type="number" id="dilshanPrice" step="0.01" placeholder="e.g., 5.10" class="form-input bg-slate-50 w-full p-3 border border-gray-300 rounded-lg text-lg" required>
                </div>
            </div>

            <!-- Calculate Button -->
            <button type="submit" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-6 rounded-lg btn-primary text-lg">
                Calculate Bill
            </button>
        </form>

    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-md flex items-center justify-center p-4 z-50 hidden">
        <div id="modalContent" class="bg-white/70 backdrop-blur-lg border border-white/20 p-8 rounded-2xl shadow-2xl w-full max-w-md relative modal-enter">
            <!-- Close Button -->
            <button id="closeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition duration-300 text-3xl font-light leading-none">&times;</button>
            
            <!-- Modal Header -->
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">Bill Breakdown</h2>
            
            <!-- Results Container -->
            <div class="space-y-4 text-lg">
                <!-- Nishat's Bill -->
                <div class="bg-rose-100/80 p-4 rounded-lg flex justify-between items-center">
                    <span class="font-medium text-rose-800">Nishat's Share</span>
                    <div class="text-right">
                        <p id="nishatResult" class="font-bold text-rose-800"></p>
                        <p id="nishatUnitsResult" class="text-sm text-rose-700"></p>
                    </div>
                </div>
                
                <!-- Dilshan's Bill -->
                <div class="bg-teal-100/80 p-4 rounded-lg flex justify-between items-center">
                    <span class="font-medium text-teal-800">Dilshan's Share</span>
                    <div class="text-right">
                        <p id="dilshanResult" class="font-bold text-teal-800"></p>
                        <p id="dilshanUnitsResult" class="text-sm text-teal-700"></p>
                    </div>
                </div>
                
                <!-- Separator -->
                <hr class="my-4 border-gray-300/50">
                
                <!-- Total Bill -->
                <div class="bg-slate-200/80 p-4 rounded-lg flex justify-between items-center">
                    <span class="font-medium text-slate-800">Total Bill</span>
                     <div class="text-right">
                        <p id="totalResult" class="font-bold text-slate-800"></p>
                        <p id="totalUnitsResult" class="text-sm text-slate-600"></p>
                    </div>
                </div>
            </div>
            
            <!-- Rounding Button -->
            <div class="text-center mt-6">
                 <button id="roundOffBtn" class="bg-slate-200/80 text-slate-700 font-semibold py-2 px-5 rounded-lg text-sm hover:bg-slate-300 transition duration-300 border border-white/30">Round Off</button>
            </div>

        </div>
    </div>
    
    <!-- Alert Toast -->
    <div id="alertToast" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-lg alert-toast opacity-0 transform translate-y-2">
        <p id="alertMessage"></p>
    </div>


    <script>
        // DOM Elements
        const billForm = document.getElementById('billForm');
        const resultModal = document.getElementById('resultModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModal');
        const alertToast = document.getElementById('alertToast');
        const alertMessage = document.getElementById('alertMessage');
        const roundOffBtn = document.getElementById('roundOffBtn');
        
        // Form Inputs
        const totalAmountInput = document.getElementById('totalAmount');
        const totalUnitsInput = document.getElementById('totalUnits');
        const nishatPresentReadingInput = document.getElementById('nishatPresentReading');
        const nishatLastReadingInput = document.getElementById('nishatLastReading');
        const nishatPriceInput = document.getElementById('nishatPrice');
        const dilshanPriceInput = document.getElementById('dilshanPrice');
        
        // Result Displays
        const nishatResultEl = document.getElementById('nishatResult');
        const nishatUnitsResultEl = document.getElementById('nishatUnitsResult');
        const dilshanResultEl = document.getElementById('dilshanResult');
        const dilshanUnitsResultEl = document.getElementById('dilshanUnitsResult');
        const totalResultEl = document.getElementById('totalResult');
        const totalUnitsResultEl = document.getElementById('totalUnitsResult');
        
        // State variables
        let alertTimeout;
        let originalNishatBill, originalDilshanBill;
        let nishatUnits, dilshanUnits;
        let roundingState = 0; // 0: initial, 1: Dilshan rounded, 2: Nishat rounded

        // Show Alert Toast Function
        function showAlert(messageText) {
            clearTimeout(alertTimeout);
            alertMessage.textContent = messageText;
            alertToast.classList.remove('opacity-0', 'translate-y-2');
            alertTimeout = setTimeout(() => {
                alertToast.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }

        // Show Modal Function
        function showModal() {
            resultModal.classList.remove('hidden');
            modalContent.classList.add('modal-enter-active');
            modalContent.classList.remove('modal-enter');
        }

        // Hide Modal Function
        function hideModal() {
             modalContent.classList.remove('modal-enter-active');
             modalContent.classList.add('modal-leave-active');
             setTimeout(() => {
                resultModal.classList.add('hidden');
                modalContent.classList.remove('modal-leave-active');
                modalContent.classList.add('modal-enter');
             }, 300);
        }
        
        // Central function to update all result displays
        function updateResultsDisplay(nishatBill, dilshanBill, nUnits, dUnits) {
            // Update main bill amounts
            nishatResultEl.textContent = `₹${nishatBill.toFixed(2)}`;
            dilshanResultEl.textContent = `₹${dilshanBill.toFixed(2)}`;
            
            // Recalculate and display effective per-unit prices
            const effectiveNishatPrice = nUnits > 0 ? nishatBill / nUnits : 0;
            const effectiveDilshanPrice = dUnits > 0 ? dilshanBill / dUnits : 0;
            
            nishatUnitsResultEl.textContent = `${nUnits.toFixed(2)} units @ ₹${effectiveNishatPrice.toFixed(2)}/unit`;
            dilshanUnitsResultEl.textContent = `${dUnits.toFixed(2)} units @ ₹${effectiveDilshanPrice.toFixed(2)}/unit`;
        }

        // Form Submission Handler
        billForm.addEventListener('submit', (e) => {
            e.preventDefault();

            // 1. Get values
            const totalAmount = parseFloat(totalAmountInput.value);
            const totalUnitsVal = parseFloat(totalUnitsInput.value);
            const nishatPresent = parseFloat(nishatPresentReadingInput.value);
            const nishatLast = parseFloat(nishatLastReadingInput.value);
            const nishatPrice = parseFloat(nishatPriceInput.value);
            const dilshanPrice = parseFloat(dilshanPriceInput.value);
            
            // 2. Validation
            if ([totalAmount, totalUnitsVal, nishatPresent, nishatLast, nishatPrice, dilshanPrice].some(isNaN) || totalUnitsVal <= 0) {
                showAlert("Please fill all fields with valid numbers.");
                return;
            }
             if (nishatLast > nishatPresent) {
                showAlert("Present reading must be greater than last month's.");
                return;
            }

            // 3. Calculations
            nishatUnits = nishatPresent - nishatLast;
            if (nishatUnits > totalUnitsVal) {
                showAlert("Nishat's units exceed total main meter units.");
                return;
            }
            dilshanUnits = totalUnitsVal - nishatUnits;

            // CORRECTED LOGIC: Calculate Nishat's share, derive Dilshan's to ensure total is always correct.
            originalNishatBill = nishatUnits * nishatPrice;
            originalDilshanBill = totalAmount - originalNishatBill;

            // 4. Update the modal display
            updateResultsDisplay(originalNishatBill, originalDilshanBill, nishatUnits, dilshanUnits);
            
            totalResultEl.textContent = `₹${totalAmount.toFixed(2)}`;
            totalUnitsResultEl.textContent = `${totalUnitsVal.toFixed(2)} units`;
            
            // Reset rounding state for new calculation
            roundingState = 0;
            roundOffBtn.textContent = "";

            // 5. Show the modal
            showModal();
        });
        
        // Rounding logic
        roundOffBtn.addEventListener('click', () => {
            roundingState = (roundingState + 1) % 3; // Cycle through 0, 1, 2
            const totalAmount = parseFloat(totalAmountInput.value);

            if (roundingState === 1) { // State 1: Round Dilshan's share up to nearest 10
                const roundedDilshan = Math.ceil(originalDilshanBill / 10) * 10;
                const adjustedNishat = totalAmount - roundedDilshan;
                updateResultsDisplay(adjustedNishat, roundedDilshan, nishatUnits, dilshanUnits);
                roundOffBtn.textContent = "";

            } else if (roundingState === 2) { // State 2: Round Nishat's share up to nearest 10
                const roundedNishat = Math.ceil(originalNishatBill / 10) * 10;
                const adjustedDilshan = totalAmount - roundedNishat;
                updateResultsDisplay(roundedNishat, adjustedDilshan, nishatUnits, dilshanUnits);
                roundOffBtn.textContent = "";

            } else { // State 0: Reset to original calculation
                updateResultsDisplay(originalNishatBill, originalDilshanBill, nishatUnits, dilshanUnits);
                roundOffBtn.textContent = "";
            }
        });

        // Event listeners to close the modal
        closeModalBtn.addEventListener('click', hideModal);
        resultModal.addEventListener('click', (e) => {
            if (e.target === resultModal) {
                hideModal();
            }
        });
    </script>
    
    <script>
        // PWA Service Worker Logic
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'calm-bill-splitter-cache-v5'; // Updated cache version
                const urlsToCache = [location.pathname];
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                    );
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => response || fetch(event.request))
                    );
                });
            `;
            const blob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered.', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>

</body>
</html>

